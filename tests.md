# E2E Test Scenarios for `@event-driven-io/emmett-hono` Adapter

This document outlines the end-to-end (E2E) test scenarios that will drive the development of the Hono adapter for Emmett. These tests aim to ensure the adapter correctly integrates Hono with Emmett's core functionalities and aligns with existing adapter conventions.

## Test Setup

- Tests will use `hono/testing`'s `testClient` or a similar utility for making requests against the Hono app instance configured with the adapter.
- An in-memory event store (`getInMemoryEventStore`) will be used initially for most tests.
- Emmett's testing helpers (`existingStream`, `expectNewEvents`, `expectResponse`, `expectError`) will be used for setup and assertions where applicable.
- A simple domain model (e.g., Shopping Cart or a basic counter) will be used for command handling tests.

## Test Scenarios

### 1. Basic Routing & Request Handling

- **Scenario 1.1:** GET request to a simple route returns the expected text response and status code (200 OK). **[Implemented, failing: response object issue]**
- **Scenario 1.2:** POST request to a simple route returns the expected JSON response and status code (e.g., 201 Created). **[Implemented, failing: response object issue]**
- **Scenario 1.3:** PUT request handling. **[Implemented, passing]**
- **Scenario 1.4:** DELETE request handling. **[Implemented, passing]**
- **Scenario 1.5:** Route with path parameters correctly extracts and uses the parameter. (`/items/:id`) **[Implemented, passing]**
- **Scenario 1.6:** Route with query parameters correctly extracts and uses single and multiple query parameters. (`/search?q=term&limit=10`) **[Implemented, passing]**
- **Scenario 1.7:** Handling of `application/x-www-form-urlencoded` request body. **[Implemented, passing]**
- **Scenario 1.8:** Handling of `application/json` request body. **[Implemented, passing]**
- **Scenario 1.9:** Handling of `multipart/form-data` request body (if planned for initial support). **[Implemented, passing]**
- **Scenario 1.10:** Request to an undefined route returns a 404 Not Found response (using Hono's default or a custom handler if implemented). **[Implemented, passing]**

### 2. Standard Response Helpers

- **Scenario 2.1:** Handler returning `OK(options)` sends correct status (200), body, and headers. **[Implemented, failing: response object issue]**
- **Scenario 2.2:** Handler returning `Created({ createdId: '...' })` sends correct status (201), body (`{ id: '...' }`), and Location header (`/resource/id`). **[Implemented, failing: response object issue]**
- **Scenario 2.3:** Handler returning `Created({ url: '...' })` sends correct status (201) and Location header. **[Implemented, passing]**
- **Scenario 2.4:** Handler returning `Accepted({ location: '...' })` sends correct status (202) and Location header. **[Implemented, failing: response object issue]**
- **Scenario 2.5:** Handler returning `NoContent()` sends correct status (204) and no body.
- **Scenario 2.6:** Handler returning `HttpResponse(statusCode, options)` sends the specified status, body, and headers.

### 3. ETag & Optimistic Concurrency

- **Scenario 3.1:** Response includes an ETag header when generated by a command handler result (`nextExpectedStreamVersion`).
- **Scenario 3.2:** Request with correct `If-Match` header succeeds.
- **Scenario 3.3:** Request with incorrect `If-Match` header fails with a 412 Precondition Failed status and Problem Details.
- **Scenario 3.4:** Request missing `If-Match` header (when required by handler logic, simulating a specific handler check) fails appropriately (e.g., 400 or 428, depending on implementation choice).
- **Scenario 3.5:** Ensure weak ETags (`W/"version"`) are generated and handled correctly.

### 4. Error Handling & Problem Details

- **Scenario 4.1:** Handler throwing `HTTPException` from Hono results in the correct status code and Problem Details response.
- **Scenario 4.2:** Handler throwing Emmett's `ValidationError` results in a 400 Bad Request Problem Details response.
- **Scenario 4.3:** Handler throwing Emmett's `IllegalStateError` results in a 403 Forbidden Problem Details response.
- **Scenario 4.4:** Handler throwing Emmett's `NotFoundError` results in a 404 Not Found Problem Details response.
- **Scenario 4.5:** Handler throwing Emmett's `ConcurrencyError` results in a 412 Precondition Failed Problem Details response.
- **Scenario 4.6:** Handler throwing a generic `Error` results in a 500 Internal Server Error Problem Details response.
- **Scenario 4.7:** Test custom error mapping provided via `getApplication` options.

### 5. Middleware Integration (Basic)

- **Scenario 5.1:** Test that default CORS headers are applied correctly when the CORS middleware is enabled via `getApplication`.
- **Scenario 5.2:** Test that default ETag headers are applied correctly when the ETag middleware is enabled via `getApplication` (and verify interaction with manual ETag setting).
- **Scenario 5.3:** Test basic request logging if `hono/logger` is included as a default/optional middleware.

### 6. Command Handling Integration

- **Scenario 6.1:** Successful command execution appends the correct event(s) to the event store.
- **Scenario 6.2:** Command execution respecting optimistic concurrency (using `If-Match` -> `expectedStreamVersion`).
- **Scenario 6.3:** Command execution failing optimistic concurrency check returns 412.
- **Scenario 6.4:** Command execution resulting in a business logic error (e.g., `IllegalStateError`) returns the appropriate mapped HTTP error (e.g., 403).

This list provides a starting point and will be expanded as development progresses and specific adapter features are implemented.
